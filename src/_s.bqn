
tâ†"ğ•¨ğ•©"
uâ†"wx"

eâ†@+27
effâ†@
histâ†âŸ¨âŸ©
châ†âŸ¨âŸ©
psâ†0 # cursor position
hiâ†0 # history position

# ctrl-enter - continue
# ctrl-. - next

clearâ†eâˆ¾"[2K"âˆ¾eâˆ¾"[0G"

Cmdâ†{ğ•Š:
  # TODO add to history
  â€¢term.OutRaw clear
  â€¢Show "command" 
  â€¢Show ğ•¨
}

# add ğ•© into ch at ps position with ğ•¨ deletions
Patchâ†{âˆ¾(âˆ¾âŸœğ•©(-ğ•¨)âŠ¸â†“)Â¨âŒ¾(1âŠ¸â†‘) ps(âŠ¢âŠ”Ëœâ‰¤âŸœ(â†•â‰ ))ch} 

# map of inputs to âŸ¨ch, ps, effâŸ© 
# ch: new character list, ps: position, eff: side effect functionâŸ©
Mapâ†{
  ğ•©:ğ•©â‰¡eâˆ¾"[D"             ? âŸ¨ch,            0âŒˆps-1,          {ğ•©}   âŸ©
; ğ•©:ğ•©â‰¡eâˆ¾"[C"             ? âŸ¨ch,            (â‰ ch)âŒŠps+1,      {ğ•©}   âŸ©
; ğ•©:ğ•©â‰¡â‰@+10              ? âŸ¨âŸ¨âŸ©,            0,               châŠ¸CmdâŸ© 
; ğ•©:ğ•©â‰¡â‰@+127             ? âŸ¨1 Patch "",    0âŒˆps-1,          {ğ•©}   âŸ©
; ğ•©:ğ•©â‰¡â‰@+21              ? âŸ¨âŸ¨âŸ©,            0,               {ğ•©}   âŸ©
; ğ•©:0=â‰ ch                ? âŸ¨ğ•©,             1,               {ğ•©}   âŸ©
; ğ•©:'\'=ch(âŠ£âŠ‘Ëœ0âŒˆâ‰ âŠ¸âŒŠ)ps-1 ? zâ†t/ËœuâˆŠğ•©
                           âŸ¨ch0â†1 Patch z, (â‰ z)+ps-1,       {ğ•©}   âŸ©
; ğ•©:                       âŸ¨ch0â†0 Patch ğ•©, ps+1,            {ğ•©}   âŸ© 
}
#âŸ¨âˆ¾(âˆ¾âŸœ(zâ†t/ËœuâˆŠğ•©))Â¨âŒ¾(1âŠ¸â†‘)châŠ”Ëœpsâ‰¤â†•â‰ ch, (â‰ z)+ps-1, {ğ•Š:â€¢Show "woo"}âŸ©

# if e consume chars until letter (ANSI format for keypresses)
Inputâ†{
   ğ•Š@:ğ•Šâ€¢term.CharB@
;  ğ•Šğ•©:ğ•©=e?ğ•©âˆ¾eğ•Šâ€¢term.CharB@
;  ğ•Šğ•©:âŸ¨ğ•©âŸ©
; eğ•Šğ•©:âŠ‘ğ•©âˆŠâˆ¾+âŸœ(â†•26)Â¨"Aa"?ğ•©
; eğ•Šğ•©:ğ•©âˆ¾eğ•Šâ€¢term.CharB@
}

â€¢term.RawMode 1
{ğ•Š:
  châ€¿psâ€¿Effâ†©Map Input@
  Eff @

  â€¢term.OutRaw clear # clear line and set to start of line
  â€¢term.OutRaw â€¢ToUTF8 ch
  â€¢term.OutRaw eâˆ¾"["âˆ¾(â€¢Fmt ps+1)âˆ¾"G"
  â€¢term.Flush@
}â€¢_while_ 1 @

